### Subgraph

Subgraph – це сервіс, який фільтрує користувачів для подальшої ліквідації. Subgraph сфокусований на користувачах зі значеннями HF, MinBorrow та MinCollateral, близькими до можливості ліквідації. Його основне завдання – профільтрувати користувачів і, якщо їх HF близький до ліквідації, відправити їх на DataFetcher.

![Users flow](../images/archiveToSubgraphFlow.jpg)

#### Основні принципи роботи Subgraph

1. **Ініціалізація**:

   - Subgraph отримує користувачів з Proxy для подальшої фільтрації.

2. **Фільтрація користувачів**:

   - Subgraph фільтрує користувачів з параметрами Health Factor (HF) від 0,5 до 2 (фільтри на вході). Користувачі зі значно більшим чи меншим HF були відкинуті на етапі Blacklist.
   - Налаштування фільтрів у Subgraph наближені до потенційних ліквідацій. Наприклад, HF у Subgraph фільтрується від 0,9 до 1,1 (фільтри на виході).

3. **Обробка та швидкість проходження кола**:

   - Якщо є 10 тисяч користувачів на протоколі Compound, коло – це час, за який обробляються всі ці користувачі.
   - На нашому продакшн-сервісі коло у Subgraph займає близько 1,5 хвилини, що є дуже гарним результатом.

4. **Взаємодія з DataFetcher**:

   - Subgraph надсилає користувачів на DataFetcher для остаточного вирішення про ліквідацію. Наприклад, якщо у користувача HF 0,95, Subgraph відправляє його на DataFetcher в топіку execute/liquidate для розрахунку вигідності ліквідації.
   - DataFetcher може здійснювати ліквідацію лише тих користувачів, яких йому в реальному часі присилає Subgraph. Тому швидкість обробки кола користувачів сервісом Subgraph є дуже важливою.

5. **Сканування по колу:**:
   - Якщо у користувача параметри залишаються в межах вихідних фільтрів Subgraph (наприклад, HF 0,95), він буде постійно відправлятися на DataFetcher до тих пір, поки не буде ліквідований або поки його параметри не вийдуть за межі фільтрів.

## Висновок

Subgraph забезпечує точну і швидку фільтрацію користувачів для подальшої ліквідації, враховуючи всі необхідні параметри. Сервіс дещо схожий на Blacklist, проте для нього важлива швидкість фільтрації.

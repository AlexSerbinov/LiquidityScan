# Загальний огляд сервісу Liquidator

![LiqRegistry Flow Diagram](../images/serviceFlow.jpg)

## Вступ

Сервіс Liquidator - це сервіс, який займається відстеженням потенційних позицій для ліквідацій і подальшої їх ліквідації. Наразі Liquidator працює у протоколах ліквідності DeFi, таких як AAVE V1, AAVE V2, AAVE V3 та Compound. Основна мета проекту - ідентифікувати користувачів, які знаходяться в зоні ризику ліквідації, та ліквідувати їх позиції. при цьому отримуючи прибуток за ліквідації

## Структура сервісу Liquidator

Сервіс Liquidator складається з двох основних підсервісів:

1. **LiqRegistry**: Відповідає за збір та фільтрацію користувачів, які взаємодіяли з підтримуваними протоколами ліквідності. І знаходить потенційні позиції для ліквідації.
2. **LiqExecutor**: Відповідає за виконання ліквідації позицій користувачів, ідентифікованих LiqRegistry.

Ця документація зосереджена на описі бізнес-логіки сервісу LiqRegistry.

## Бізнес-логіка LiqRegistry

LiqRegistry працює з протоколами ліквідності AAVE V1, AAVE V2, AAVE V3 та Compound. Основна задача сервісу - знайти користувачів, які взяли кредит у будь-якому з цих протоколів, та відслідковувати їхній Health Factor (показник, наскільки користувач наближений до ліквідації.), Borrow, та Collateral.

Процес роботи LiqRegistry можна розділити на три основні етапи:

1. **Фільтрація блокчейну**: Сервіс профільтровує весь блокчейн, щоб знайти користувачів, які взаємодіяли з одним із чотирьох підтримуваних протоколів.
2. **Фільтрація користувачів**: Знайдені користувачі фільтруються за певними критеріями, такими як мінімальний розмір кредиту (Borrow), мінімальний розмір застави (Collateral) та Health Factor.
3. **Детальний аналіз вибраних користувачів**: Більш детальний аналіз по певним юзерам. Аналіз їх ассетів в Borrow, та в Collateral. Також симуляція зміни Health Factor на основі транзакції зміни ціни (Transmit)
4. **Передача даних на LiqExecutor**: Після фільтрації інформація про користувачів, що підлягають ліквідації, передається на сервіс LiqExecutor для виконання ліквідації.

LiqRegistry - це ключовий компонент системи Liquidator, який відповідає за пошук і відстеження користувачів протоколів ліквідності, потенційно придатних для ліквідації. LiqRegistry складається з семи підсервісів, кожен з яких виконує специфічну роль у процесі фільтрації та моніторингу користувачів:

1. **Archive** - збирає всіх користувачів, які коли-небудь взаємодіяли з кожним окремим протоколом, починаючи з блоку створення протоколу. Archive також відстежує нових користувачів у реальному часі.

2. **Blacklist** - перший етап фільтрації користувачів за параметрами Health Factor, MinBorrow та MinCollateral. Він відсіює користувачів, чиї параметри занадто далекі від потенційно цікавих для ліквідації.

3. **Proxy** - допоміжний сервіс для Subgraph, який розподіляє користувачів між інстансами Subgraph для ефективної обробки.

4. **Subgraph** - фільтрує користувачів, зосереджуючись на тих, чиї параметри Health Factor, MinBorrow та MinCollateral близькі до можливості ліквідації. Відправляє відфільтрованих користувачів на DataFetcher.

5. **DataFetcher** - приймає рішення про ліквідацію користувачів або додавання їх до WatchList для подальшого моніторингу на основі детального аналізу їх параметрів.

6. **TransmitFetcher** - моніторить транзакції Transmit у mempool для виявлення змін цін на токени, що впливають на Health Factor користувачів з WatchList, дозволяючи ліквідувати їх у тому ж блоці, де змінюється Health Factor.

Додатково, сервіс

7. **Events** відповідає за моніторинг виходу нових блоків, відправку цих блоків по MQTT та оновлення globalReservesData.

Всі ці сервіси працюють як єдиний механізм, поступово звужуючи список користувачів на кожному етапі, щоб у кінцевому підсумку виявити тих, хто найбільш підходить для ліквідації і передати цих користувачів на наступний сервіс liqExecutor. Такий підхід дозволяє ефективно використовувати обмежені ресурси системи при роботі з великою кількістю користувачів протоколів ліквідності.

Кожен сервіс має свої `filters` у яких зазначаються параметри для відбору. Проходячи через воронку, фільтри звужуються, щоб відсіяти нерелевантних користувачів для ліквідації.

```javascript
    "min_collateral_amount": 0.01,
    "min_borrow_amount": 0.01,
    "min_health_factor": 0.5,
    "max_health_factor": 1.8
```

Детальну роботу кожного сервісу ви можете знайти в окремих підрозділах документації

## Бізнес-логіка LiqExecutor

Після знаходження позицій для ліквідації сервісом LiqRegistry, LiqExecutor аналізує можливість ліквідації та потенційний прибуток від неї, враховуючи можливі шляхи (path) ліквідації, ціну на газ для транзакції ліквідації тощо.


